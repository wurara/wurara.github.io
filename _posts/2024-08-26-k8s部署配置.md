---
layout: post
title: 构建k8s运行环境
subtitle: 在启动k8s前的操作
cover-img: /assets/img/path.jpg
thumbnail-img: /assets/img/thumb.png
share-img: /assets/img/path.jpg
tags: [books, test]
---

1. swapoff

     ```shell
     # 临时关闭swap分区, 重启失效;
     swapoff -a
     
     # 永久关闭swap分区
     sed -ri 's/.*swap.*/#&/' /etc/fstab
     ```

2. 同步时间

   1. 安装ntp

   ```shell
   sudo yum install ntp ntpdate ntp-doc
   ntpdate xx.xx.xx.xx
   ```

   2. 配置/etc/ntp.conf

   ```shell
   # 添加 server xx.xx.xx.xx prefer 条目
   # Use public servers from the pool.ntp.org project.
   # Please consider joining the pool (http://www.pool.ntp.org/join.html).
   server xx.xx.xx.xx prefer
   ```

   3. 启动

   ```shell
   # 配置ntpd服务自启动
   sudo systemctl enable ntpd
   # 启动ntpd
   sudo systemctl start ntpd
   ```

   

3. 安装docker
     1. 设置仓库
     2. 安装docker

      ```shell
      sudo yum install docker-ce-20.10.8 docker-ce-cli-20.10.8 containerd.io
      ```

     3. 设置自动启动

      ```shell
   systemctl start docker
      systemctl enable docker
      ```
      
     4. 设置证书

      从其他机子拿证书上传到下面这几个新建文件夹

      ```shell
      mkdir /etc/docker/certs.d/
      scp -r root@xx.xx.xx.xx:/etc/docker/certs.d/ /etc/docker
      docker login xx.xx.xx.xx
      ```

4. 升级内核

     1. 设置仓库
     2. 安装内核

      ```shell
      sudo yum install kernel-lt-5.4.278-1.el7.elrepo.x86_64
      sudo grub2-mkconfig -o /boot/grub2/grub.cfg
      sudo grub2-set-default 0
      ```

      ```shell
      #查看内核
      sudo awk -F\' '$1=="menuentry " {print i++ " : " $2}' /etc/grub2.cfg
      ```

     3. 重启

      重启需要半个多小时

      ```shell
      reboot
      ```
